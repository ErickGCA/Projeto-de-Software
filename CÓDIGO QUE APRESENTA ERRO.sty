import React, { useEffect, useState } from "react";
import { Button, Form, Modal, Tab, Tabs } from "react-bootstrap";
import api from "../../api/api";

function CODIGO1({ show, handleClose, title, item, onSave }) {
  const [formData, setFormData] = useState({
    id: "",
    username: "",
    nis: "",
    cpf: "",
    endereco: "",
    telefone: "",
    mes: "",
    familiasPAIF: 0,
    novasFamiliasPAIF: 0,
    familiasExtremaPobreza: 0,
    bolsaFamilia: 0,
    descumprimentoCondicionalidades: 0,
    bpc: 0,
    trabalhoInfantil: 0,
    acolhimento: 0,
    atendimentosCRAS: 0,
    cadastroUnico: 0,
    atualizacaoCadastral: 0,
    bpcIndividuos: 0,
    creas: 0,
    visitasDomiciliares: 0,
    auxiliosNatalidade: 0,
    auxiliosFuneral: 0,
    outrosBeneficios: 0,
    familiasParticipantesPAIF: 0,
    criancas06SCFV: 0,
    criancas714SCFV: 0,
    adolescentes1517SCFV: 0,
    adultosSCFV: 0,
    idososSCFV: 0,
    palestrasOficinas: 0,
    pessoasDeficiencia: 0,
    filiadoUsername: "",
    filiadoCpf: "",
    dataNascimento: "",
    beneficiario: "",
    beneficiarioId: "",
    beneficiarioNome: "",
    categoriaId: "",
  });

  const [beneficiarios, setBeneficiarios] = useState([]);
  const [categorias, setCategorias] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [filteredBeneficiarios, setFilteredBeneficiarios] = useState([]);
  const [isSearching, setIsSearching] = useState(false);
  const [activeTab, setActiveTab] = useState("basics");

  const mesesTraducao = {
    JANEIRO: "JANUARY",
    FEVEREIRO: "FEBRUARY",
    MARCO: "MARCH",
    ABRIL: "APRIL",
    MAIO: "MAY",
    JUNHO: "JUNE",
    JULHO: "JULY",
    AGOSTO: "AUGUST",
    SETEMBRO: "SEPTEMBER",
    OUTUBRO: "OCTOBER",
    NOVEMBRO: "NOVEMBER",
    DEZEMBRO: "DECEMBER",
  };

  const mesesToPortugues = {
    JANUARY: "JANEIRO",
    FEBRUARY: "FEVEREIRO",
    MARCH: "MARCO",
    APRIL: "ABRIL",
    MAY: "MAIO",
    JUNE: "JUNHO",
    JULY: "JULHO",
    AUGUST: "AGOSTO",
    SEPTEMBER: "SETEMBRO",
    OCTOBER: "OUTUBRO",
    NOVEMBER: "NOVEMBRO",
    DECEMBER: "DEZEMBRO",
  };

  // Efeito para carregar dados iniciais
  useEffect(() => {
    if (item) {
      setFormData({
        ...item,
        categoriaId: item.categoria?.id || "",
        beneficiarioId: item.beneficiario?.id || "",
        beneficiarioNome: item.beneficiario?.username || "",
        mes: mesesToPortugues[item.mes] || item.mes,
      });
      if (item.beneficiario?.username) {
        setSearchTerm(item.beneficiario.username);
      }
    }
  }, [item]);

  // Efeito para carregar categorias
  useEffect(() => {
    const fetchCategorias = async () => {
      try {
        const response = await api.get("/categorias");
        setCategorias(response.data);
      } catch (err) {
        console.error("Erro ao buscar categorias:", err);
      }
    };

    fetchCategorias();
  }, []);

  // Efeito para carregar beneficiários
  useEffect(() => {
    const fetchBeneficiarios = async () => {
      try {
        const response = await api.get("/Beneficiario");
        setBeneficiarios(response.data);
        setFilteredBeneficiarios(response.data);
      } catch (err) {
        console.error("Erro ao buscar beneficiários:", err);
      }
    };

    fetchBeneficiarios();
  }, []);

  // Efeito para filtrar beneficiários
  useEffect(() => {
    if (isSearching) {
      const results = beneficiarios.filter(
        (beneficiario) =>
          beneficiario.username
            .toLowerCase()
            .includes(searchTerm.toLowerCase()) ||
          beneficiario.cpf
            .replace(/\D/g, "")
            .includes(searchTerm.replace(/\D/g, "")) ||
          (beneficiario.nis && beneficiario.nis.includes(searchTerm))
      );
      setFilteredBeneficiarios(results);
    }
  }, [searchTerm, beneficiarios, isSearching]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: name === "mes" ? mesesTraducao[value] || value : value,
    }));
  };

  const handleBeneficiarioSearchChange = (e) => {
    const value = e.target.value;
    setSearchTerm(value);
    setIsSearching(true);

    if (!value) {
      setFormData((prev) => ({
        ...prev,
        beneficiarioId: "",
        beneficiarioNome: "",
      }));
    }
  };

  const handleBeneficiarioSelect = (beneficiario) => {
    setFormData((prev) => ({
      ...prev,
      beneficiarioId: beneficiario.id,
      beneficiarioNome: beneficiario.username,
    }));
    setSearchTerm(beneficiario.username);
    setIsSearching(false);
  };

  const formatCPF = (cpf) => {
    const numbers = cpf.replace(/\D/g, "");
    return numbers.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  };

  const handleSubmit = async () => {
    try {
      // Handle filiado creation if on filiado tab
      if (activeTab === "filiado" && formData.filiadoUsername) {
        const filiadoData = {
          username: formData.filiadoUsername,
          cpf: formData.filiadoCpf,
          data: formData.dataNascimento,
          beneficiario: {
            id: formData.beneficiarioId,
          },
        };

        try {
          await api.post("/filiado", filiadoData);
        } catch (error) {
          console.error("Error creating filiado:", error);
          return;
        }
      }

      // Prepare beneficiário data
      const beneficiarioData = {
        ...formData,
        categoria: formData.categoriaId
          ? {
              id: formData.categoriaId,
            }
          : null,
      };

      // Remove campos auxiliares
      delete beneficiarioData.categoriaId;
      delete beneficiarioData.beneficiarioId;
      delete beneficiarioData.beneficiarioNome;

      // Config para evitar erro 415
      const config = {
        headers: {
          "Content-Type": "application/json",
        },
      };

      let response;
      if (formData.id) {
        response = await api.put(
          `/Beneficiario/${formData.id}`,
          beneficiarioData,
          config
        );
      } else {
        response = await api.post("/Beneficiario", beneficiarioData, config);
      }

      // Update categoria if needed
      if (formData.categoriaId) {
        try {
          const categoriaResponse = await api.get(
            `/categorias/${formData.categoriaId}`
          );
          const categoria = categoriaResponse.data;
          const beneficiarios = categoria.beneficiarios || [];

          if (!beneficiarios.find((b) => b.id === response.data.id)) {
            beneficiarios.push(response.data);
            await api.put(
              `/categorias/${formData.categoriaId}`,
              {
                ...categoria,
                beneficiarios,
              },
              config
            );
          }
        } catch (error) {
          console.error("Erro ao atualizar categoria:", error);
        }
      }

      // Prepare final data for frontend
      const savedData = {
        ...response.data,
        categoria: formData.categoriaId
          ? {
              id: formData.categoriaId,
            }
          : null,
      };

      onSave(savedData);
      handleClose();
    } catch (error) {
      console.error("Error in form submission:", error);
    }
  };

  const searchStyles = {
    inputContainer: {
      position: "relative",
      marginBottom: "1rem",
    },
    beneficiarioList: {
      position: "absolute",
      top: "100%",
      left: 0,
      right: 0,
      maxHeight: "200px",
      overflowY: "auto",
      backgroundColor: "white",
      border: "1px solid #ddd",
      borderRadius: "4px",
      zIndex: 1000,
      boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
    },
    beneficiarioItem: {
      padding: "8px 12px",
      cursor: "pointer",
      borderBottom: "1px solid #eee",
    },
    beneficiarioInfo: {
      display: "flex",
      flexDirection: "column",
    },
    beneficiarioName: {
      fontWeight: "bold",
    },
    beneficiarioDetails: {
      fontSize: "0.9em",
      color: "#666",
    },
  };

  return (
    <Modal show={show} onHide={handleClose}>
      <Modal.Header closeButton>
        <Modal.Title>{title}</Modal.Title>
      </Modal.Header>
      <Modal.Body>
        <Tabs
          activeKey={activeTab}
          onSelect={(k) => setActiveTab(k)}
          className="mb-3"
        >
          <Tab eventKey="basics" title="Informações Básicas">
            <Form>
              <Form.Group controlId="formUsername">
                <Form.Label>Nome</Form.Label>
                <Form.Control
                  type="text"
                  name="username"
                  value={formData.username}
                  onChange={handleChange}
                />
              </Form.Group>
              <Form.Group controlId="formNis">
                <Form.Label>NIS</Form.Label>
                <Form.Control
                  type="text"
                  name="nis"
                  value={formData.nis}
                  onChange={handleChange}
                />
              </Form.Group>
              <Form.Group controlId="formCpf">
                <Form.Label>CPF</Form.Label>
                <Form.Control
                  type="text"
                  name="cpf"
                  value={formData.cpf}
                  onChange={handleChange}
                />
              </Form.Group>
              <Form.Group controlId="formEndereco">
                <Form.Label>Endereço</Form.Label>
                <Form.Control
                  type="text"
                  name="endereco"
                  value={formData.endereco}
                  onChange={handleChange}
                />
              </Form.Group>
              <Form.Group controlId="formTelefone">
                <Form.Label>Telefone</Form.Label>
                <Form.Control
                  type="text"
                  name="telefone"
                  value={formData.telefone}
                  onChange={handleChange}
                />
                <Form.Group controlId="formCategoria">
                  <Form.Label>Categoria</Form.Label>
                  <Form.Control
                    as="select"
                    name="categoriaId"
                    value={formData.categoriaId || ""}
                    onChange={handleChange}
                  >
                    <option value="">Selecione uma categoria</option>
                    {categorias.map((categoria) => (
                      <option key={categoria.id} value={categoria.id}>
                        {categoria.nome}{" "}
                        {/* O nome da categoria pode variar dependendo do seu modelo */}
                      </option>
                    ))}
                  </Form.Control>
                </Form.Group>
              </Form.Group>
            </Form>
          </Tab>